name: Deploy Infrastructure

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      backendImageTag:
        description: "Backend image tag"
        required: false
        default: "latest"
      frontendImageTag:
        description: "Frontend image tag"
        required: false
        default: "latest"
      llmProcessorImageTag:
        description: "LLM Processor image tag"
        required: false
        default: "latest"
      gatewayImageTag:
        description: "Gateway image tag"
        required: false
        default: "latest"

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    outputs:
      llmProcessorUrl: ${{ steps.get-outputs.outputs.llmProcessorUrl }}
      backendUrl: ${{ steps.get-outputs.outputs.backendUrl }}
      frontendUrl: ${{ steps.get-outputs.outputs.frontendUrl }}
      certificateName: ${{ steps.get-outputs.outputs.certificateName }}
      createCert: ${{ steps.check-cert.outputs.createCert }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Check Certificate Existence
        id: check-cert
        run: |
          echo "ðŸ” Checking if certificate exists..."
          CERT_COUNT=$(az containerapp env certificate list \
            --name FinanceApp \
            --resource-group projects \
            --query "length([?properties.subjectName=='www.financeapp.fun'])" \
            --output tsv)

          if [ "$CERT_COUNT" -gt 0 ]; then
            echo "âœ… Certificate exists"
            echo "createCert=false" >> $GITHUB_OUTPUT
          else
            echo "âŒ Certificate does not exist"
            echo "createCert=true" >> $GITHUB_OUTPUT
          fi

      - name: Deploy Template
        uses: azure/arm-deploy@v2
        with:
          resourceGroupName: projects
          template: ./main.bicep
          deploymentMode: Incremental
          deploymentName: deploy-${{ github.run_number }}
          parameters: >
            sqlAdministratorLogin=${{ secrets.SQL_ADMIN_LOGIN }}
            sqlAdministratorPassword=${{ secrets.SQL_ADMIN_PASSWORD }}
            containerRegistryUsername=${{ secrets.GHCR_USERNAME }}
            containerRegistryPassword=${{ secrets.GHCR_PAT }}
            openAiApiKey=${{ secrets.OPENAI_API_KEY }}
            authenticationSecretKey=${{ secrets.SECRET_KEY }}
            authenticationAudience=${{ vars.AUDIENCE }}
            authenticationIssuer=${{ vars.ISSUER }}
            smtpHost=${{ vars.SMTP_HOST }}
            smtpUser=${{ secrets.SMTP_USER }}
            smtpPassword=${{ secrets.SMTP_PASSWORD }}
            smtpFromEmail=${{ secrets.SMTP_FROM_EMAIL }}
            exchangeRateApiUrl=${{ vars.EXCHANGE_RATE_API_URL }}
            exchangeRateApiEndpoint=${{ vars.EXCHANGE_RATE_API_ENDPOINT }}
            exchangeRateApiAppId=${{ secrets.EXCHANGE_RATE_APP_ID }}
            rabbitMqUsername=${{ secrets.RABBITMQ_USER }}
            rabbitMqPassword=${{ secrets.RABBITMQ_PASS }}
            rabbitMqHost=${{ vars.RABBITMQ_HOST }}
            rabbitMqPort=${{ vars.RABBITMQ_PORT }}
            redisPassword=${{ secrets.REDIS_PASSWORD }}
            dbConnectionString="${{ secrets.DB_CONNECTION_STRING }}"
            redisConnectionString=${{ secrets.CACHE_CONNECTION_STRING }}
            llmProcessorApiToken=${{ secrets.LLM_PROCESSOR_TOKEN }}
            llmProcessorApiUrl=${{ vars.LLM_PROCESSOR_API_URL }}
            mcpApiBaseUrl=${{ vars.MCP_API_BASE_URL }}
            backendImageTag=${{ github.event.inputs.backendImageTag || 'latest' }}
            frontendImageTag=${{ github.event.inputs.frontendImageTag || 'latest' }}
            llmProcessorImageTag=${{ github.event.inputs.llmProcessorImageTag || 'latest' }}
            gatewayImageTag=${{ github.event.inputs.gatewayImageTag || 'latest' }}
            createGatewayCertificate=${{ steps.check-cert.outputs.createCert }}
            environment=production

      - name: Display Deployment Outputs
        id: get-outputs
        run: |
          echo "âœ… Deployment completed successfully!"
          echo "Deployment name: deploy-${{ github.run_number }}"

          # Get deployment outputs
          az deployment group show \
            --resource-group projects \
            --name deploy-${{ github.run_number }} \
            --query properties.outputs \
            --output json > deployment-outputs.json

          echo "ðŸ“Š Deployment Outputs:"
          cat deployment-outputs.json | jq '.'

          # Extract and display URLs
          echo ""
          echo "ðŸŒ Application URLs:"
          echo "Frontend: https://$(cat deployment-outputs.json | jq -r '.frontendUrl.value')"
          echo "Gateway: https://$(cat deployment-outputs.json | jq -r '.gatewayUrl.value')"
          echo "Backend: http://$(cat deployment-outputs.json | jq -r '.backendUrl.value')"
          echo "LLM Processor: http://$(cat deployment-outputs.json | jq -r '.llmProcessorUrl.value')"

          echo ""
          echo "ðŸ’¾ Infrastructure:"
          echo "SQL Server: $(cat deployment-outputs.json | jq -r '.sqlServerFqdn.value')"
          echo "Log Analytics: $(cat deployment-outputs.json | jq -r '.logAnalyticsWorkspaceId.value')"

          # Set outputs for next job
          echo "llmProcessorUrl=$(cat deployment-outputs.json | jq -r '.llmProcessorUrl.value')" >> $GITHUB_OUTPUT
          echo "backendUrl=$(cat deployment-outputs.json | jq -r '.backendUrl.value')" >> $GITHUB_OUTPUT
          echo "frontendUrl=$(cat deployment-outputs.json | jq -r '.frontendUrl.value')" >> $GITHUB_OUTPUT
          echo "certificateName=www.financeapp.fun" >> $GITHUB_OUTPUT

  bind-certificate:
    needs: deploy
    if: needs.deploy.outputs.createCert == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Deploy Stage - Bind SSL Certificate
        uses: azure/arm-deploy@v2
        with:
          resourceGroupName: projects
          template: ./cert-binding.bicep
          deploymentMode: Incremental
          deploymentName: cert-binding-${{ github.run_number }}
          parameters: >
            containerRegistryUsername=${{ secrets.GHCR_USERNAME }}
            containerRegistryPassword=${{ secrets.GHCR_PAT }}
            certificateName=${{ needs.deploy.outputs.certificateName }}
            llmProcessorUrl=https://${{ needs.deploy.outputs.llmProcessorUrl }}
            backendUrl=https://${{ needs.deploy.outputs.backendUrl }}
            frontendUrl=https://${{ needs.deploy.outputs.frontendUrl }}
            gatewayImageTag=${{ github.event.inputs.gatewayImageTag || 'latest' }}
            environment=production

      - name: Display Cert Binding Stage Outputs
        run: |
          echo "âœ… Cert Binding Stage - SSL Certificate binding completed!"
          echo ""
          echo "ðŸ”’ Custom Domain with SSL:"
          echo "Gateway with SSL: https://www.financeapp.fun"
